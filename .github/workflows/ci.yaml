# CI for Product Catalo Service

name: product-catalog-ci

on:
  pull_request:
    branches:
      - main

jobs:
    build:
      runs-on: ubuntu-latest
      
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Go 1.22
          uses: actions/setup-go@v4
          with:
            go-version: '1.22'

        - name: Build
          run: |
            cd src/product-catalog
            go mod download
            go build -o product-catalog-service main.go

        - name: unit tests
          run: |
            cd src/product-catalog
            go test ./...

    code-quality:
      runs-on: ubuntu-latest
      
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        # - name: Run golangci-lint
        #   uses: golangci/golangci-lint-action@v6
        #   with:
        #     version: v1.64.8
        #     working-directory: src/product-catalog

    docker:
      runs-on: ubuntu-latest

      needs: build

      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Install Docker
          uses: docker/setup-buildx-action@v2
        
        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Docker Push
          uses: docker/build-push-action@v6
          with:
            context: src/product-catalog
            file: src/product-catalog/Dockerfile
            push: true
            tags: ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog-service:${{ github.run_id}}
    
    updatek8s:
      runs-on: ubuntu-latest

      # needs: [build, docker, code-quality]
      needs: [build, docker]

      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.TOKEN }}

        - name: Update tag in kubernetes deployment manifest
          run: |
                sed -i "s|image: .*|image: ${{ secrets.DOCKERHUB_USERNAME }}/product-catalog:${{github.run_id}}|" kubernetes/productcatalog/deploy.yaml

        - name: Commit and push changes
          run: |
            git config --global user.email "haoweilee.tpe.com"
            git config --global user.name "GitHub Action"
            git add kubernetes/productcatalog/deploy.yaml
            git commit -m "[CI]: Update product-catalog image tag to :${{ github.run_id }}"
            git push